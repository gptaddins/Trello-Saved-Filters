<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Custom Filters</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body { margin: 0; padding: 10px; font-family: Arial, sans-serif; }
    input, select { width: 100%; padding: 5px; margin-bottom: 10px; }
    #save-preset { margin-top: 10px; }
    #presets-list { list-style: none; padding: 0; }
    li { margin: 5px 0; padding: 5px; border: 1px solid #ccc; }
    .preset { cursor: pointer; color: blue; }
    button { margin-left: 5px; }
    #instructions { color: #666; font-size: 0.9em; margin-top: 10px; }
  </style>
</head>
<body>
  <input type="text" id="filter-text" placeholder="Search text (e.g., 'start')">
  <select id="filter-status">
    <option value="">Any List</option>
  </select>
  <select id="filter-assignee">
    <option value="">Any Assignee</option>
  </select>
  <button id="apply-filter">Apply Filter</button>
  <button id="clear-filter">Clear Filter</button>
  <button id="copy-filter-link">Copy Filter Link</button> <!-- New button -->
  <div>
    <input type="text" id="preset-name" placeholder="Preset name">
    <button id="save-preset">Save Preset</button>
  </div>
  <h3>Saved Presets</h3>
  <ul id="presets-list"></ul>
  <div id="instructions">
    This tool updates card badges to indicate filtered cards. Click "Copy Filter Link" to get a URL with your filter criteria, then paste it into your browser to apply the filter on the board. Alternatively, use Trelloâ€™s native filter icon (funnel) manually.
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const appKey = "72d09526a2855680e12a04e38b04637c";
      const appName = "Saved Filters";
      const t = window.TrelloPowerUp.iframe({ appKey, appName });

      t.render(async () => {
        try {
          const lists = await t.lists('id', 'name');
          const statusSelect = document.getElementById('filter-status');
          if (statusSelect) {
            statusSelect.innerHTML = '<option value="">Any List</option>' + 
              lists.map(list => `<option value="${list.id}">${list.name}</option>`).join('');
          }

          const boardMembers = await t.board('members');
          const members = boardMembers.members;
          const assigneeSelect = document.getElementById('filter-assignee');
          if (assigneeSelect) {
            assigneeSelect.innerHTML = '<option value="">Any Assignee</option>' + 
              members.map(member => `<option value="${member.id}">${member.fullName}</option>`).join('');
          }

          const data = await t.get('board', 'private', 'savedFilters', { presets: [], filteredCardIds: [], activeFilter: null });
          updatePresetsList(data.presets);

          if (data.activeFilter) {
            document.getElementById('filter-text').value = data.activeFilter.text || '';
            statusSelect.value = data.activeFilter.status || '';
            assigneeSelect.value = data.activeFilter.assignee || '';
          }

          document.getElementById('apply-filter').addEventListener('click', async () => {
            console.log('Applying filter...');
            const activeFilter = {
              text: document.getElementById('filter-text').value,
              status: document.getElementById('filter-status').value,
              assignee: document.getElementById('filter-assignee').value
            };
            try {
              const data = await t.get('board', 'private', 'savedFilters', { presets: [] });
              data.activeFilter = activeFilter;
              await t.set('board', 'private', 'savedFilters', data);
              await t.render(() => Promise.resolve([]));
              console.log('Filter applied, badges updated, closing popup...');
              setTimeout(() => t.closePopup(), 1000);
            } catch (error) {
              console.error('Error applying filter:', error);
            }
          });

          document.getElementById('clear-filter').addEventListener('click', async () => {
            console.log('Clearing filter...');
            try {
              const data = await t.get('board', 'private', 'savedFilters', { presets: [] });
              data.activeFilter = null;
              await t.set('board', 'private', 'savedFilters', data);
              await t.render(() => Promise.resolve([]));
              console.log('Filter cleared, badges updated, closing popup...');
              setTimeout(() => t.closePopup(), 1000);
            } catch (error) {
              console.error('Error clearing filter:', error);
            }
          });

          document.getElementById('copy-filter-link').addEventListener('click', async () => {
            console.log('Generating filter link...');
            const activeFilter = {
              text: document.getElementById('filter-text').value,
              status: document.getElementById('filter-status').value,
              assignee: document.getElementById('filter-assignee').value
            };
            const board = await t.board('id');
            let filterParams = '';
            if (activeFilter.text) filterParams += `text:${encodeURIComponent(activeFilter.text)}`;
            if (activeFilter.status) filterParams += (filterParams ? '&' : '') + `list:${activeFilter.status}`;
            if (activeFilter.assignee) filterParams += (filterParams ? '&' : '') + `member:${activeFilter.assignee}`;
            const filterUrl = `https://trello.com/b/${board.id}/?filter=${filterParams}`;
            try {
              await navigator.clipboard.writeText(filterUrl);
              console.log('Filter link copied to clipboard:', filterUrl);
              alert('Filter link copied to clipboard! Paste it into your browser to apply the filter.');
            } catch (error) {
              console.error('Error copying to clipboard:', error);
              alert('Failed to copy filter link. Please copy manually: ' + filterUrl);
            }
          });

          document.getElementById('save-preset').addEventListener('click', async () => {
            console.log('Saving preset...');
            const presetName = document.getElementById('preset-name').value.trim();
            if (presetName) {
              const preset = {
                name: presetName,
                text: document.getElementById('filter-text').value,
                status: document.getElementById('filter-status').value,
                assignee: document.getElementById('filter-assignee').value
              };
              try {
                const data = await t.get('board', 'private', 'savedFilters', { presets: [] });
                data.presets.push(preset);
                await t.set('board', 'private', 'savedFilters', data);
                updatePresetsList(data.presets);
                document.getElementById('preset-name').value = '';
                console.log('Preset saved.');
              } catch (error) {
                console.error('Error saving preset:', error);
              }
            }
          });
        } catch (error) {
          console.error('Render error:', error);
        }
      });

      function updatePresetsList(presets) {
        const list = document.getElementById('presets-list');
        if (list) {
          list.innerHTML = '';
          presets.forEach((preset, index) => {
            const li = document.createElement('li');
            li.textContent = preset.name;
            const applyBtn = document.createElement('button');
            applyBtn.textContent = 'Apply';
            applyBtn.onclick = () => {
              document.getElementById('filter-text').value = preset.text || '';
              document.getElementById('filter-status').value = preset.status || '';
              document.getElementById('filter-assignee').value = preset.assignee || '';
              document.getElementById('apply-filter').click();
            };
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.onclick = async () => {
              try {
                const data = await t.get('board', 'private', 'savedFilters');
                data.presets.splice(index, 1);
                await t.set('board', 'private', 'savedFilters', data);
                updatePresetsList(data.presets);
                console.log('Preset deleted.');
              } catch (error) {
                console.error('Error deleting preset:', error);
              }
            };
            li.append(applyBtn, deleteBtn);
            list.appendChild(li);
          });
        }
      }
    });
  </script>
</body>
</html>
