<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Custom Filters</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body { margin: 0; padding: 10px; font-family: Arial, sans-serif; }
    input, select { width: 100%; padding: 5px; margin-bottom: 10px; }
    #save-filter { margin-top: 10px; }
    #presets, #results { list-style: none; padding: 0; }
    li { margin: 5px 0; padding: 5px; border: 1px solid #ccc; }
    .preset { cursor: pointer; color: blue; }
    button { margin-left: 5px; }
  </style>
</head>
<body>
  <input type="text" id="search-text" placeholder="Search text (e.g., 'start')">
  <select id="status-filter">
    <option value="">Any Status</option>
    <option value="active">Active</option>
  </select>
  <select id="assignee-filter">
    <option value="">Any Assignee</option>
    <!-- Placeholder for assignee; will use current user for now -->
    <option value="current">Assigned to Me</option>
  </select>
  <button id="apply">Apply Filter</button>
  <div>
    <input type="text" id="filter-alias" placeholder="Filter alias (e.g., 'open cards')">
    <button id="save-filter">Save Filter</button>
  </div>
  <h3>Saved Filters</h3>
  <ul id="presets"></ul>
  <h3>Filtered Cards</h3>
  <ul id="results"></ul>

  <script>
    var t = window.TrelloPowerUp.iframe({
      appKey: '72d09526a2855680e12a04e38b04637c',
      appName: 'Saved Filters',
      appAuthor: 'GPT AddIns'
    });

    // Get current member ID as a workaround (simplified)
    t.get('member', 'id').then(function(memberId) {
      var assigneeSelect = document.getElementById('assignee-filter');
      if (memberId) {
        var option = document.createElement('option');
        option.value = memberId;
        option.textContent = 'Me';
        assigneeSelect.appendChild(option);
      }
    });

    // Load saved filters
    t.get('board', 'private', 'savedFilters', []).then(function(savedFilters) {
      var presetsList = document.getElementById('presets');
      savedFilters.forEach(function(filter) {
        var li = document.createElement('li');
        li.className = 'preset';
        li.textContent = filter.alias;
        li.onclick = function() {
          document.getElementById('search-text').value = filter.text || '';
          document.getElementById('status-filter').value = filter.status || '';
          document.getElementById('assignee-filter').value = filter.assignee || '';
          applyFilter(filter);
        };
        presetsList.appendChild(li);
      });
    });

    // Apply filter button
    document.getElementById('apply').onclick = function() {
      var filter = getCurrentFilter();
      applyFilter(filter);
    };

    // Save filter button
    document.getElementById('save-filter').onclick = function() {
      var alias = document.getElementById('filter-alias').value.trim();
      if (alias) {
        var filter = getCurrentFilter();
        filter.alias = alias;
        t.get('board', 'private', 'savedFilters', []).then(function(savedFilters) {
          savedFilters.push(filter);
          t.set('board', 'private', 'savedFilters', savedFilters).then(refreshPresets);
        });
      }
    };

    function getCurrentFilter() {
      return {
        text: document.getElementById('search-text').value,
        status: document.getElementById('status-filter').value,
        assignee: document.getElementById('assignee-filter').value === 'current' ? t.get('member', 'id') : document.getElementById('assignee-filter').value
      };
    }

    function applyFilter(filter) {
      var resultsList = document.getElementById('results');
      resultsList.innerHTML = 'Filtering...';
      t.cards('all').then(function(cards) {
        resultsList.innerHTML = '';
        var filteredCards = cards.filter(card => matchesFilter(card, filter));
        if (filteredCards.length > 0) {
          filteredCards.forEach(function(card) {
            var li = document.createElement('li');
            var a = document.createElement('a');
            a.href = card.url;
            a.textContent = card.name + ' (List: ' + (card.idListName || 'Unknown List') + ')';
            a.target = '_blank';
            li.appendChild(a);
            resultsList.appendChild(li);
          });
        } else {
          resultsList.innerHTML = 'No cards match the filter.';
        }
        t.set('board', 'private', 'activeFilter', filter); // Update active filter
        t.render(); // Refresh badges
      }).catch(function(error) {
        resultsList.innerHTML = 'Error: ' + error.message;
      });
    }

    function refreshPresets() {
      t.closePopup().then(function() {
        t.popup({
          title: 'Custom Filters',
          url: './popup.html',
          height: 500
        });
      });
    }

    // Helper function to check if a card matches the filter
    function matchesFilter(card, filter) {
      var textMatch = !filter.text || (card.name && card.name.toLowerCase().includes(filter.text.toLowerCase()));
      var statusMatch = !filter.status || (filter.status === 'active' && !card.closed);
      var assigneeMatch = !filter.assignee || (card.idMembers && card.idMembers.includes(filter.assignee));
      return textMatch && statusMatch && assigneeMatch;
    }
  </script>
</body>
</html>
